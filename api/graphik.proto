syntax = "proto3";

package api;

option go_package = "apipb";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/any.proto";
import "google/protobuf/empty.proto";
import "go-proto-validators/validator.proto";

// Timing describes timing
enum Timing {
  BEFORE =0;
  AFTER =1;
}

// Path describes a node/edge type & id
message Path {
  string gtype =1 [(validator.field) = {regex : "^.{1,225}$"}];
  string gid =2;
}

message Metadata {
  google.protobuf.Timestamp created_at =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Timestamp updated_at =2 [(validator.field) = {msg_exists : true}];
  Path updated_by =3 [(validator.field) = {msg_exists : true}];
  uint64 sequence =4 [(validator.field) = {int_gt : 0}];
  uint64 version =5 [(validator.field) = {int_gt : 0}];
  string hash =6 [(validator.field) = {regex : "^.{1,225}$"}];
}

// Paths is an array of paths
message Paths {
  repeated Path paths =1;
}

// Node is a Graph primitive representing a single entity/resource. It is connected to other nodes via Edges
message Node {
  Path path =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Struct attributes =2;
  Metadata metadata =3 [(validator.field) = {msg_exists : true}];
}

// NodeConstructor is used to create a node
message NodeConstructor {
  Path path =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Struct attributes =3;
}

// NodeConstructor is used to create a batch of nodes
message NodeConstructors {
  repeated NodeConstructor nodes =1;
}

// Nodes is an array of nodes
message Nodes {
  repeated Node nodes =1;
}

// NodeDetail is a node with its connected edges
message NodeDetail {
  Path path =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Struct attributes =2;
  EdgeDetails edges_from =3;
  EdgeDetails edges_to =4;
  Metadata metadata =5 [(validator.field) = {msg_exists : true}];
}

// NodeDetails is an array of NodeDetail
message NodeDetails {
  repeated NodeDetail node_details =1;
}

// NodeDetailFilter is used to fetch node details
message NodeDetailFilter {
  Path path =1 [(validator.field) = {msg_exists : true}];
  Filter from_edges =2;
  Filter to_edges =3;
}

// Edge is a graph primitive that represents a relationship between two nodes
message Edge {
  Path path =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Struct attributes =2;
  bool directed =3;
  Path from =4 [(validator.field) = {msg_exists : true}];
  Path to =5 [(validator.field) = {msg_exists : true}];
  Metadata metadata =6 [(validator.field) = {msg_exists : true}];
}

// EdgeConstructor is used to create an Edge
message EdgeConstructor {
  Path path =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Struct attributes =3;
  bool directed =4;
  Path from =5 [(validator.field) = {msg_exists : true}];
  Path to =6 [(validator.field) = {msg_exists : true}];
}

// EdgeConstructors is an array of EdgeConstructor
message EdgeConstructors {
  repeated EdgeConstructor edges =1;
}

// Edges is an array of Edge
message Edges {
  repeated Edge edges =1;
}

// EdgeDetail is an edge with both of it's connected nodes fully loaded
message EdgeDetail {
  Path path =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Struct attributes =2;
  bool directed =3;
  Node from =4 [(validator.field) = {msg_exists : true}];
  Node to =5 [(validator.field) = {msg_exists : true}];
  Metadata metadata =6 [(validator.field) = {msg_exists : true}];
}

// EdgeDetails is an array of EdgeDetail
message EdgeDetails {
  repeated EdgeDetail edges =1;
}

// EdgeFilter is used to fetch edges
message EdgeFilter {
  Path node_path =1 [(validator.field) = {msg_exists : true}];
  string gtype =2 [(validator.field) = {regex : "^.{1,225}$"}];
  repeated string expressions =3;
  int32 limit =4 [(validator.field) = {int_gt : 0}];
}

// Filter is a generic filter using Common Expression Language
message Filter {
  string gtype =1 [(validator.field) = {regex : "^.{1,225}$"}];
  repeated string expressions =2;
  int32 limit =3 [(validator.field) = {int_gt : 0}];
}

// MeFilter is used to fetch a NodeDetail representing the identity in the inbound JWT token
message MeFilter {
  Filter edges_from =1;
  Filter edges_to =2;
}

// ChannelFilter is used to filter messages in a pubsub channel
message ChannelFilter {
  string channel =1 [(validator.field) = {regex : "^.{1,225}$"}];
  repeated string expressions =2;
}

// SubGraphFilter is used to filter nodes/edges in the graph
message SubGraphFilter {
  Filter nodes =1 [(validator.field) = {msg_exists : true}];
  Filter edges =2 [(validator.field) = {msg_exists : true}];
}

// Graph is an array of nodes and edges
message Graph {
  Nodes nodes =1;
  Edges edges =2;
}

// Patch patches the attributes of a Node or Edge
message Patch {
  Path path =1 [(validator.field) = {msg_exists : true}];
  google.protobuf.Struct attributes =2;
}

message PatchFilter {
  Patch patch =1;
  Filter filter =2;
}

// Pong returns PONG if the server is healthy
message Pong {
  string message =1;
}

// OutboundMessage is a message to be published to a pubsub channel
message OutboundMessage {
  string channel =1 [(validator.field) = {regex : "^.{1,225}$"}];
  google.protobuf.Struct data =2 [(validator.field) = {msg_exists : true}];
}

// Message is received on PubSub subscriptions
message Message {
  string channel =1 [(validator.field) = {regex : "^.{1,225}$"}];
  google.protobuf.Struct data =2 [(validator.field) = {msg_exists : true}];
  Path sender =3 [(validator.field) = {msg_exists : true}];
  google.protobuf.Timestamp timestamp=4 [(validator.field) = {msg_exists : true}];
}

// Schema returns registered edge & node types
message Schema {
  repeated string edge_types =1;
  repeated string node_types =2;
}

message NodeChange {
  Node before = 4;
  Node after = 5;
}

message EdgeChange {
  Edge before = 4;
  Edge after = 5;
}

message Change {
  string method =1 [(validator.field) = {regex : "^.{1,225}$"}];
  Node identity =2 [(validator.field) = {msg_exists : true}];
  google.protobuf.Timestamp timestamp =3 [(validator.field) = {msg_exists : true}];
  repeated EdgeChange edge_changes =4;
  repeated  NodeChange node_changes =5;
}

message ExpressionFilter {
  repeated string expressions =1;
}

// GraphService is the primary Graph service
service GraphService {
  // Ping returns PONG if the server is health
  rpc Ping(google.protobuf.Empty) returns(Pong) {}
  // GetSchema gets schema about the Graph node & edge types
  rpc GetSchema(google.protobuf.Empty) returns(Schema){}
 // Me returns a NodeDetail of the currently logged in identity(the subject of the JWT)
  rpc Me(MeFilter) returns(NodeDetail){}
  // CreateNode creates a node in the graph
  rpc CreateNode(NodeConstructor) returns(Node){}
  // CreateNodes creates a batch of nodes in the graph
  rpc CreateNodes(NodeConstructors) returns(Nodes){}
  // GetNode gets a single node in the graph
  rpc GetNode(Path) returns(Node){}
  // SearchNodes searches the graph for nodes
  rpc SearchNodes(Filter) returns(Nodes){}
  // PatchNode patches a nodes attributes
  rpc PatchNode(Patch) returns(Node){}
  // PatchNodes patches a batch of nodes attributes
  rpc PatchNodes(PatchFilter) returns(Nodes){}
  // CreateEdge creates an edge in the graph
  rpc CreateEdge(EdgeConstructor) returns(Edge){}
  // CreateEdges creates a batch of edges in the graph
  rpc CreateEdges(EdgeConstructors) returns(Edges){}
  // GetEdge gets a single edge in the graph
  rpc GetEdge(Path) returns(Edge){}
  // SearchEdges searches the graph for edges
  rpc SearchEdges(Filter) returns(Edges){}
  // PatchEdge patches an edges attributes
  rpc PatchEdge(Patch) returns(Edge){}
  // PatchEdges patches a batch of edges attributes
  rpc PatchEdges(PatchFilter) returns(Edges){}
  // EdgesFrom returns edges that source from the given node path that pass the filter
  rpc EdgesFrom(EdgeFilter) returns(Edges){}
  // EdgesTo returns edges that point to the given node path that pass the filter
  rpc EdgesTo(EdgeFilter) returns(Edges){}
  // Publish publishes a message to a pubsub channel
  rpc Publish(OutboundMessage) returns(google.protobuf.Empty){}
  // Subscribe subscribes to messages on a pubsub channel
  rpc Subscribe(ChannelFilter) returns(stream Message){}
  rpc SubscribeChanges(ExpressionFilter) returns(stream Change){}
  // Import imports the Graph into the database
  rpc Import(Graph) returns(Graph){}
  // Export returns the Graph data
  rpc Export(google.protobuf.Empty) returns (Graph){}
  // SubGraph returns a subgraph using the given filter
  rpc SubGraph(SubGraphFilter) returns(Graph){}
  // Shutdown shuts down the database
  rpc Shutdown(google.protobuf.Empty) returns(google.protobuf.Empty){}
}

message Interception {
  string method =1 [(validator.field) = {regex : "^.{1,225}$"}];
  Node identity =2 [(validator.field) = {msg_exists : true}];
  google.protobuf.Timestamp timestamp =3 [(validator.field) = {msg_exists : true}];
  google.protobuf.Any request = 4 [(validator.field) = {msg_exists : true}];
  google.protobuf.Any response = 5 [(validator.field) = {msg_exists : true}];
  Timing timing =6;
}

// TriggerService is an optional/custom external plugin that when added to a graphik instance, mutates requests & responses at runtime
service TriggerService {
  // Ping returns PONG if the server is health
  rpc Ping(google.protobuf.Empty) returns(Pong) {}
  // Mutate mutates request/responses
  rpc Mutate(Interception) returns(Interception){}
  // Filter returns a set of expressions used to determine whether the request/response will be sent to the Mutation function.
  // These expressions are cached by the Graphik server
  rpc Filter(google.protobuf.Empty) returns(ExpressionFilter){}
}